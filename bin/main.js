// Generated by CoffeeScript 1.12.2
(function() {
  var DOMAIN, allOtherFieldsFull, append, displayError, displayUrl, getAllInputFields, getAllInputFieldsExceptLast, getAllUrlFields, sendRequest, shortenBtn,
    indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  DOMAIN = "https://mstch.herokuapp.com/";

  if (process.env.WEB_URL != null) {
    DOMAIN = process.env.WEB_URL;
  }

  shortenBtn = $('#shorten')[0];

  sendRequest = function(urlVals) {
    return $.ajax({
      url: 'js/server.js',
      type: 'POST',
      data: {
        url: JSON.stringify(urlVals)
      },
      success: function(res) {
        var resJSON;
        resJSON = $.parseJSON(res);
        if (resJSON.hashedUrl) {
          return displayUrl(resJSON.hashedUrl);
        } else if (resJSON.error) {
          return displayError(resJSON.error);
        }
      }
    });
  };

  displayUrl = function(path) {
    var innerHtml;
    innerHtml = "<a href='" + path + "'>" + DOMAIN + " " + path + "</a>";
    return append("shortenedUrl", innerHtml);
  };

  displayError = function(error) {
    var innerHtml;
    innerHtml = "<p>" + error + "</p>";
    return append("error", innerHtml);
  };

  append = function(containerId, content) {
    var container;
    container = $("<div id='" + containerId + "'></div>");
    container.html(content);
    return $('body').append(container);
  };

  allOtherFieldsFull = function(currentEl) {
    var field, fieldVal, i, inputFields, len;
    inputFields = getAllInputFields();
    for (i = 0, len = inputFields.length; i < len; i++) {
      field = inputFields[i];
      fieldVal = $.trim(field.value);
      if (fieldVal.length === 0 && field !== currentEl) {
        return false;
      }
    }
    return true;
  };

  $('#urlfield-container').on('focus', 'input.urlfield', function(e) {
    if (allOtherFieldsFull(e.target)) {
      return UrlField.addAnotherField('#urlfield-container');
    }
  });

  $('#urlfield-container').on('blur', 'input.urlfield', function(e) {
    var field, fieldVal, i, inputFields, len, results;
    inputFields = getAllInputFields();
    results = [];
    for (i = 0, len = inputFields.length; i < len; i++) {
      field = inputFields[i];
      fieldVal = field.value;
      results.push($(field).val($.trim(fieldVal)));
    }
    return results;
  });

  shortenBtn.onclick = function(e) {
    var urlField, urlFields, urlVals;
    urlFields = getAllUrlFields();
    e.preventDefault();
    urlVals = (function() {
      var i, len, results;
      results = [];
      for (i = 0, len = urlFields.length; i < len; i++) {
        urlField = urlFields[i];
        results.push(urlField.getVal());
      }
      return results;
    })();
    if (indexOf.call(urlVals, false) >= 0) {
      return alert('Not a good a url :(');
    } else {
      return sendRequest(urlVals);
    }
  };

  getAllInputFieldsExceptLast = function() {
    var inputFields;
    inputFields = $('.urlfield');
    inputFields.splice(1, -1);
    return inputFields;
  };

  getAllInputFields = function() {
    var inputFields;
    return inputFields = $('.urlfield');
  };

  getAllUrlFields = function() {
    var inputField, inputFields, urlFields;
    inputFields = getAllInputFieldsExceptLast();
    return urlFields = (function() {
      var i, len, results;
      results = [];
      for (i = 0, len = inputFields.length; i < len; i++) {
        inputField = inputFields[i];
        if (!!inputField.value) {
          results.push(new UrlField(inputField));
        }
      }
      return results;
    })();
  };

}).call(this);
